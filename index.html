<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Video Call UI</title>
<style>
  body {
    margin: 0;
    background-color: #0d0d0d;
    font-family: 'Segoe UI', sans-serif;
    overflow: hidden;
    color: #fff;
  }

  /* CONTROLS */
  #controls {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    background: rgba(30,30,30,0.8);
    padding: 12px 20px;
    border-radius: 30px;
    backdrop-filter: blur(8px);
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    z-index: 1000;
  }

  button, .dropdown-btn {
    background: #222;
    color: #fff;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s ease;
    position: relative;
  }

  button:hover, .dropdown-btn:hover {
    background: #555;
    transform: scale(1.05);
  }

  .off {
    background: #aa2222 !important;
  }

  .dropdown-content {
    position: absolute;
    background: #222;
    display: none;
    flex-direction: column;
    top: -100px; /* dropdown comes from top */
    border-radius: 12px;
    padding: 5px 0;
    box-shadow: 0 5px 15px rgba(0,0,0,0.6);
    animation: slideDown 0.3s ease forwards;
    z-index: 2000;
  }

  .dropdown-content button {
    width: 100%;
    padding: 8px 12px;
    border-radius: 0;
    text-align: left;
  }

  @keyframes slideDown {
    0% { opacity: 0; transform: translateY(-10px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  /* VIDEO BOX */
  .video-box {
    position: absolute;
    border-radius: 15px;
    overflow: hidden;
    cursor: grab;
    resize: both;
    min-width: 150px;
    min-height: 85px;
    width: 220px;
    height: 124px; /* fixed 16:9 ratio */
    box-shadow: 0 8px 20px rgba(0,0,0,0.6);
    border: 2px solid #333;
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .video-box:hover {
    transform: scale(1.03);
    box-shadow: 0 12px 25px rgba(0,0,0,0.8);
  }

  .speaking {
    border-color: #0f0;
    box-shadow: 0 0 20px #0f0;
  }

  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  #videoContainer {
    width: 100%;
    height: 100%;
    position: relative;
  }
</style>
</head>
<body>

<div id="controls">
  <button id="muteBtn">Mute</button>
  <div style="position: relative;">
    <button class="dropdown-btn" id="camBtn">Cam ▼</button>
    <div class="dropdown-content" id="camDropdown"></div>
  </div>
  <div style="position: relative;">
    <button class="dropdown-btn" id="micBtn">Mic ▼</button>
    <div class="dropdown-content" id="micDropdown"></div>
  </div>
  <button id="shareBtn">Screen Share</button>
</div>

<div id="videoContainer"></div>

<script>
  const videoContainer = document.getElementById('videoContainer');
  const muteBtn = document.getElementById('muteBtn');
  const camBtn = document.getElementById('camBtn');
  const micBtn = document.getElementById('micBtn');
  const camDropdown = document.getElementById('camDropdown');
  const micDropdown = document.getElementById('micDropdown');
  const shareBtn = document.getElementById('shareBtn');

  let localStream;
  let muted = false;
  let camOff = false;
  let currentVideoTrack;
  let currentAudioTrack;

  async function init() {
    const devices = await navigator.mediaDevices.enumerateDevices();

    devices.forEach(device => {
      if(device.kind === 'videoinput') {
        const btn = document.createElement('button');
        btn.textContent = device.label || `Camera ${camDropdown.children.length+1}`;
        btn.onclick = () => switchCamera(device.deviceId);
        camDropdown.appendChild(btn);
      }
      if(device.kind === 'audioinput') {
        const btn = document.createElement('button');
        btn.textContent = device.label || `Mic ${micDropdown.children.length+1}`;
        btn.onclick = () => switchMic(device.deviceId);
        micDropdown.appendChild(btn);
      }
    });

    await startStream();
  }

  async function startStream(camId, micId) {
    if(localStream){
      localStream.getTracks().forEach(t => t.stop());
    }
    localStream = await navigator.mediaDevices.getUserMedia({
      video: camId ? {deviceId: camId} : true,
      audio: micId ? {deviceId: micId} : true
    });

    currentVideoTrack = localStream.getVideoTracks()[0];
    currentAudioTrack = localStream.getAudioTracks()[0];

    const box = document.createElement('div');
    box.className = 'video-box';
    box.style.top = '50px';
    box.style.left = '50px';
    const video = document.createElement('video');
    video.srcObject = localStream;
    video.autoplay = true;
    video.muted = true;
    box.appendChild(video);
    videoContainer.appendChild(box);
    dragElement(box);
    animateSpeaking(box);
  }

  function animateSpeaking(box) {
    const audioContext = new AudioContext();
    const analyser = audioContext.createAnalyser();
    const source = audioContext.createMediaStreamSource(localStream);
    source.connect(analyser);
    analyser.fftSize = 512;
    const dataArray = new Uint8Array(analyser.frequencyBinCount);

    function check() {
      analyser.getByteFrequencyData(dataArray);
      const avg = dataArray.reduce((a,b)=>a+b,0)/dataArray.length;
      if(avg > 10){
        box.classList.add('speaking');
      } else {
        box.classList.remove('speaking');
      }
      requestAnimationFrame(check);
    }
    check();
  }

  async function switchCamera(id){
    const newStream = await navigator.mediaDevices.getUserMedia({ video: {deviceId: id}, audio: muted ? false : true });
    localStream.removeTrack(currentVideoTrack);
    localStream.addTrack(newStream.getVideoTracks()[0]);
    currentVideoTrack = newStream.getVideoTracks()[0];
    if(camOff) currentVideoTrack.enabled = false;
    updateButtonColors();
  }

  async function switchMic(id){
    const newStream = await navigator.mediaDevices.getUserMedia({ audio: {deviceId: id}, video: camOff ? false : true });
    localStream.removeTrack(currentAudioTrack);
    localStream.addTrack(newStream.getAudioTracks()[0]);
    currentAudioTrack = newStream.getAudioTracks()[0];
    if(muted) currentAudioTrack.enabled = false;
    updateButtonColors();
  }

  function updateButtonColors(){
    muteBtn.classList.toggle('off', muted);
    camBtn.classList.toggle('off', camOff);
  }

  muteBtn.onclick = () => {
    muted = !muted;
    currentAudioTrack.enabled = !muted;
    updateButtonColors();
  }

  camBtn.onclick = (e) => {
    e.stopPropagation();
    camDropdown.style.display = camDropdown.style.display === 'flex' ? 'none' : 'flex';
    micDropdown.style.display = 'none';
  }

  micBtn.onclick = (e) => {
    e.stopPropagation();
    micDropdown.style.display = micDropdown.style.display === 'flex' ? 'none' : 'flex';
    camDropdown.style.display = 'none';
  }

  document.addEventListener('click', () => {
    camDropdown.style.display = 'none';
    micDropdown.style.display = 'none';
  })

  // toggle cam on/off when you click inside dropdown area (first button)
  camDropdown.addEventListener('click', (e)=>{
    camOff = !camOff;
    if(currentVideoTrack) currentVideoTrack.enabled = !camOff;
    updateButtonColors();
  });

  shareBtn.onclick = async () => {
    try{
      const screenStream = await navigator.mediaDevices.getDisplayMedia({video:true});
      const box = document.createElement('div');
      box.className = 'video-box';
      box.style.top = '200px';
      box.style.left = '200px';
      box.style.height = '124px';
      box.style.width = '220px';
      const video = document.createElement('video');
      video.srcObject = screenStream;
      video.autoplay = true;
      box.appendChild(video);
      videoContainer.appendChild(box);
      dragElement(box);
    } catch(e){
      console.log('Screen share canceled');
    }
  }

  function dragElement(elmnt){
    let pos1 = 0,pos2 = 0,pos3 = 0,pos4 = 0;
    elmnt.onmousedown = dragMouseDown;
    function dragMouseDown(e){
      e.preventDefault();
      elmnt.style.cursor = "grabbing";
      pos3 = e.clientX; pos4 = e.clientY;
      document.onmouseup = closeDragElement;
      document.onmousemove = elementDrag;
    }
    function elementDrag(e){
      e.preventDefault();
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX; pos4 = e.clientY;
      let newTop = elmnt.offsetTop - pos2;
      let newLeft = elmnt.offsetLeft - pos1;
      elmnt.style.top = newTop + "px";
      elmnt.style.left = newLeft + "px";
    }
    function closeDragElement(){
      elmnt.style.cursor = "grab";
      document.onmouseup = null;
      document.onmousemove = null;
    }
  }

  init();
</script>

</body>
</html>
